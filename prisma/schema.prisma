generator client {
  provider = "prisma-client-js"
}


datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Enums
enum Role {
  USER
  CREATOR
  ADMIN
}

enum CallOfferStatus {
  AVAILABLE
  BOOKED
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum CallRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum PayoutStatus {
  PENDING           // Initial state, awaiting payment
  HELD              // Payment succeeded, funds held for 7 days
  READY             // Holding period passed, ready for transfer
  PENDING_APPROVAL  // Awaiting admin approval
  APPROVED          // Approved by admin, ready for Stripe processing
  REJECTED          // Rejected by admin
  PROCESSING        // Transfer in progress
  PAID              // Successfully transferred to creator (formerly PAID)
  FAILED            // Transfer failed
  CANCELLED         // Cancelled (refund/dispute)
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  CALL_REQUEST
  REVIEW_RECEIVED
  PAYOUT_COMPLETED
  SYSTEM
}

// User's payout schedule enums
enum PayoutSchedule {
  DAILY
  WEEKLY
  MANUAL
}

enum PayoutAction {
  TRIGGERED
  BLOCKED
  UNBLOCKED
  COMPLETED
  FAILED
}

// Payment system enums
enum PayoutMode {
  AUTOMATIC
  MANUAL
}

enum PayoutFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum TransactionEventType {
  PAYMENT_CREATED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  REFUND_CREATED
  REFUND_SUCCEEDED
  REFUND_FAILED
  PAYOUT_CREATED
  PAYOUT_PAID
  PAYOUT_FAILED
  TRANSFER_CREATED
  TRANSFER_SUCCEEDED
  TRANSFER_FAILED
  WEBHOOK_RECEIVED
  DISPUTE_CREATED
  DISPUTE_UPDATED
  DISPUTE_CLOSED
}

enum EntityType {
  PAYMENT
  PAYOUT
  REFUND
  DISPUTE
  TRANSFER
}

enum RefundStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum DisputeStatus {
  WARNING_NEEDS_RESPONSE
  WARNING_UNDER_REVIEW
  WARNING_CLOSED
  NEEDS_RESPONSE
  UNDER_REVIEW
  CHARGE_REFUNDED
  WON
  LOST
}

// Models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  creator       Creator?
  bookings      Booking[]
  callRequests  CallRequest[]
  reviews       Review[]
  notifications Notification[]
  accounts      Account[]
  sessions      Session[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Creator {
  id                 String          @id @default(cuid())
  userId             String          @unique
  bio                String?         @db.Text
  profileImage       String?
  stripeAccountId    String?
  isStripeOnboarded  Boolean         @default(false)
  
  // ✅ NEW: Creator's currency (automatically detected from Stripe Connect account)
  currency           String          @default("EUR") // EUR, CHF, USD, GBP, etc.
  
  // User's payout settings (from feature branch)
  payoutSchedule     PayoutSchedule  @default(WEEKLY)
  payoutMinimum      Decimal         @default(10) @db.Decimal(10, 2)
  isPayoutBlocked    Boolean         @default(false)
  payoutBlockReason  String?
  
  // Payment system fields
  payoutBlocked        Boolean  @default(false)
  payoutBlockedReason  String?  @db.Text
  
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Relations
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  callOffers           CallOffer[]
  callRequestsReceived CallRequest[]       @relation("CreatorRequests")
  reviewsReceived      Review[]            @relation("CreatorReviews")
  payouts              Payout[]
  payoutAuditLogs      PayoutAuditLog[]
  payoutScheduleNew    PayoutScheduleNew?
  refundsInitiated     Refund[]            @relation("RefundInitiator")

  @@index([userId])
  @@index([isPayoutBlocked])
  @@index([currency])
}

model CallOffer {
  id              String          @id @default(cuid())
  creatorId       String
  title           String
  description     String          @db.Text
  price           Decimal         @db.Decimal(10, 2)
  
  // ✅ NEW: Offer currency (same as creator's currency)
  currency        String          @default("EUR") // EUR, CHF, USD, GBP, etc.
  
  dateTime        DateTime
  duration        Int             // in minutes
  status          CallOfferStatus @default(AVAILABLE)
  maxParticipants Int             @default(1)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  creator Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  booking Booking?

  @@index([creatorId])
  @@index([status])
  @@index([dateTime])
  @@index([currency])
}

model Booking {
  id                     String        @id @default(cuid())
  userId                 String
  callOfferId            String        @unique
  status                 BookingStatus @default(PENDING)
  totalPrice             Decimal       @db.Decimal(10, 2)
  stripePaymentIntentId  String?
  dailyRoomUrl           String?
  dailyRoomName          String?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  callOffer CallOffer  @relation(fields: [callOfferId], references: [id], onDelete: Cascade)
  payment   Payment?
  review    Review?

  @@index([userId])
  @@index([status])
}

model Payment {
  id                     String        @id @default(cuid())
  bookingId              String        @unique
  amount                 Decimal       @db.Decimal(10, 2)
  
  // ✅ NEW: Payment currency (same as creator's currency)
  currency               String        @default("EUR") // EUR, CHF, USD, GBP, etc.
  
  stripePaymentIntentId  String
  status                 PaymentStatus @default(PENDING)
  platformFee            Decimal       @db.Decimal(10, 2)
  creatorAmount          Decimal       @db.Decimal(10, 2)
  refundedAmount         Decimal       @db.Decimal(10, 2) @default(0)
  disputeStatus          String?
  createdAt              DateTime      @default(now())
  
  // Payout tracking fields
  payoutStatus           PayoutStatus  @default(HELD)
  payoutReleaseDate      DateTime?     // Date when funds can be transferred (payment date + 7 days)
  stripeTransferId       String?       // Stripe transfer ID when payout is completed
  payoutDate             DateTime?     // Date when payout was actually transferred

  // Relations
  booking        Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  refunds        Refund[]
  disputes       Dispute[]
  transactionLogs TransactionLog[] @relation("PaymentLogs")

  @@index([stripePaymentIntentId])
  @@index([payoutStatus])
  @@index([currency])
}

model CallRequest {
  id               String            @id @default(cuid())
  userId           String
  creatorId        String
  proposedPrice    Decimal           @db.Decimal(10, 2)
  proposedDateTime DateTime
  message          String            @db.Text
  status           CallRequestStatus @default(PENDING)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator Creator @relation("CreatorRequests", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([creatorId])
  @@index([status])
}

model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  userId    String
  creatorId String
  rating    Int      // 1-5
  comment   String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator Creator @relation("CreatorReviews", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([creatorId])
  @@index([rating])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Payout {
  id              String       @id @default(cuid())
  creatorId       String
  amount          Decimal      @db.Decimal(10, 2) // Original amount in EUR (database currency)
  stripePayoutId  String?
  status          PayoutStatus @default(PENDING)
  failureReason   String?      @db.Text
  rejectionReason String?      @db.Text // Reason for admin rejection
  approvedById    String?      // Admin user ID who approved/rejected
  approvedAt      DateTime?    // When approved/rejected
  retriedCount    Int          @default(0)
  
  // ✅ NEW: Currency conversion tracking
  amountPaid      Decimal?     @db.Decimal(10, 2) // Actual amount paid in Stripe currency (if different from EUR)
  currency        String?      @default("EUR") // Stripe account currency (EUR, CHF, USD, etc.)
  conversionRate  Decimal?     @db.Decimal(10, 6) // Conversion rate used (if applicable)
  conversionDate  DateTime?    // When conversion was calculated
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  creator         Creator          @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  transactionLogs TransactionLog[] @relation("PayoutLogs")

  @@index([creatorId])
  @@index([status])
  @@index([currency])
}

model AdminSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@index([key])
}

// User's audit log model
model PayoutAuditLog {
  id               String        @id @default(cuid())
  creatorId        String
  action           PayoutAction
  amount           Decimal?      @db.Decimal(10, 2)
  status           PayoutStatus?
  stripePayoutId   String?
  adminId          String?
  reason           String?       @db.Text
  metadata         String?       @db.Text // JSON string for additional data
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  creator Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([action])
  @@index([createdAt])
}

// Platform-wide financial settings (singleton pattern - should have only one row)
model PlatformSettings {
  id                      String   @id @default(cuid())
  platformFeePercentage   Decimal  @db.Decimal(5, 2) // e.g., 15.00 for 15%
  platformFeeFixed        Decimal? @db.Decimal(10, 2) // Optional fixed fee in addition to percentage
  minimumPayoutAmount     Decimal  @db.Decimal(10, 2) // e.g., 10.00 EUR
  holdingPeriodDays       Int      // e.g., 7 days
  payoutMode              PayoutMode @default(AUTOMATIC)
  payoutFrequencyOptions  String[] // e.g., ["DAILY", "WEEKLY", "MONTHLY"]
  currency                String   @default("EUR")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// Comprehensive audit log for all financial transactions
model TransactionLog {
  id              String               @id @default(cuid())
  eventType       TransactionEventType
  entityType      EntityType
  entityId        String               // ID of the related entity (payment, payout, refund, etc.)
  stripeEventId   String?              // Stripe event ID for webhook events
  amount          Decimal?             @db.Decimal(10, 2)
  currency        String?
  status          String?
  metadata        Json?                // Additional structured data
  errorMessage    String?              @db.Text
  createdAt       DateTime             @default(now())

  // Optional relations
  paymentId       String?
  payoutId        String?
  refundId        String?

  payment         Payment?  @relation("PaymentLogs", fields: [paymentId], references: [id], onDelete: SetNull)
  payout          Payout?   @relation("PayoutLogs", fields: [payoutId], references: [id], onDelete: SetNull)
  refund          Refund?   @relation("RefundLogs", fields: [refundId], references: [id], onDelete: SetNull)

  @@index([eventType])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([stripeEventId])
}

// Refund tracking
model Refund {
  id              String       @id @default(cuid())
  paymentId       String
  amount          Decimal      @db.Decimal(10, 2)
  currency        String       @default("EUR")
  reason          String       @db.Text
  status          RefundStatus @default(PENDING)
  stripeRefundId  String?      @unique
  initiatedById   String       // Admin/Creator who initiated the refund
  metadata        Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  payment         Payment          @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  initiatedBy     Creator          @relation("RefundInitiator", fields: [initiatedById], references: [id])
  transactionLogs TransactionLog[] @relation("RefundLogs")

  @@index([paymentId])
  @@index([status])
  @@index([stripeRefundId])
}

// Dispute/Chargeback tracking
model Dispute {
  id                String        @id @default(cuid())
  paymentId         String
  stripeDisputeId   String        @unique
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("EUR")
  reason            String
  status            DisputeStatus
  evidenceDetails   Json?         // Store evidence submission details
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  payment           Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@index([stripeDisputeId])
}

// Per-creator payout scheduling (renamed to avoid conflict with enum)
model PayoutScheduleNew {
  id              String          @id @default(cuid())
  creatorId       String          @unique
  mode            PayoutMode      @default(AUTOMATIC)
  frequency       PayoutFrequency @default(WEEKLY)
  nextPayoutDate  DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  creator         Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([nextPayoutDate])
  @@index([isActive])
}
